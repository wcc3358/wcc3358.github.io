<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>方案 | 车联网内部技术分享</title>
    <meta name="description" content="种一棵树最好的时间是十年前，其次就是现在。">
    <link rel="icon" href="/asserts/logo.ico">
  <link rel="manifest" href="/manifest.json">
    
    <link rel="preload" href="/assets/css/0.styles.2a44c9fb.css" as="style"><link rel="preload" href="/assets/js/app.822e4d04.js" as="script"><link rel="preload" href="/assets/js/2.4b49f509.js" as="script"><link rel="preload" href="/assets/js/11.f07c6990.js" as="script"><link rel="prefetch" href="/assets/js/10.08b464f2.js"><link rel="prefetch" href="/assets/js/12.2cad40a1.js"><link rel="prefetch" href="/assets/js/13.0fb47cf3.js"><link rel="prefetch" href="/assets/js/14.a5a3191c.js"><link rel="prefetch" href="/assets/js/15.6406fc0f.js"><link rel="prefetch" href="/assets/js/3.c3de1893.js"><link rel="prefetch" href="/assets/js/4.5c66387e.js"><link rel="prefetch" href="/assets/js/5.0a185102.js"><link rel="prefetch" href="/assets/js/6.05c7d38e.js"><link rel="prefetch" href="/assets/js/7.cc828aa1.js"><link rel="prefetch" href="/assets/js/8.4a254ebc.js"><link rel="prefetch" href="/assets/js/9.6b6a01b6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2a44c9fb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">车联网内部技术分享</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/vuepress/" class="nav-link">Vuepress</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="智联中心" class="dropdown-title"><span class="title">智联中心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/link/dataCenter/" class="nav-link router-link-exact-active router-link-active">基础数据中心</a></li><li class="dropdown-item"><!----> <a href="/link/ota/" class="nav-link">OTA</a></li><li class="dropdown-item"><!----> <a href="/link/fence/" class="nav-link">电子围栏</a></li></ul></div></div><div class="nav-item"><a href="http://iov.changan.com.cn/acenter/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  智云平台
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/vuepress/" class="nav-link">Vuepress</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="智联中心" class="dropdown-title"><span class="title">智联中心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/link/dataCenter/" class="nav-link router-link-exact-active router-link-active">基础数据中心</a></li><li class="dropdown-item"><!----> <a href="/link/ota/" class="nav-link">OTA</a></li><li class="dropdown-item"><!----> <a href="/link/fence/" class="nav-link">电子围栏</a></li></ul></div></div><div class="nav-item"><a href="http://iov.changan.com.cn/acenter/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  智云平台
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>基础数据中心</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/link/dataCenter/" class="active sidebar-link">方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/link/dataCenter/#概述" class="sidebar-link">概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/link/dataCenter/#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#必要性" class="sidebar-link">必要性</a></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#涉及表" class="sidebar-link">涉及表</a></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#接口开放方式" class="sidebar-link">接口开放方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#方案-2" class="sidebar-link">方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/link/dataCenter/#第一阶段：从库使用" class="sidebar-link">第一阶段：从库使用</a></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#第二阶段：缓存启用" class="sidebar-link">第二阶段：缓存启用</a></li><li class="sidebar-sub-header"><a href="/link/dataCenter/#第三阶段：完善api，local-cache确定" class="sidebar-link">第三阶段：完善API，Local Cache确定</a></li></ul></li></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>API</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/link/dataCenter/GUIDE.html" class="sidebar-link">使用</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="方案"><a href="#方案" class="header-anchor">#</a> 方案</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p>随着智云平台不断发展，大规模并发用户、海量数据成为了平台必须面对的技术挑战，平台各系统对基础数据的大量访问开始成为数据库性能瓶颈。提供一个具备高性能的访问基础数据的系统成为必要，构建基础数据系统需要借助构建统一缓存技术改进应用系统架构，提升系统并发访问响应速度和海量数据处理能力。</p> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p>基础数据池系统提供车联网人-车-设备-卡数据的统一查询访问，并使用高可用方案保证性能。</p> <h3 id="必要性"><a href="#必要性" class="header-anchor">#</a> 必要性</h3> <p>数据库压力大、redis缓存资源浪费、重复编码、数据缺失一致性</p> <blockquote><p>（1）目前几乎每个系统都需要使用人-车-设备-卡数据，每个系统均会直接访问数据主库的数据，导致目前数据主库的压力太高，如：正式环境tu-api访问设备表的sql语句每小时高达800万条；</p> <p>（2）访问人-车-设备-卡数据的系统为了提高效率和性能通常会在系统中做缓存，但每个系统均使用自己的方式在往redis中做缓存，同一份记录存成了不同的redis数据，造成了redis资源的浪费；</p> <p>（3）访问人-车-设备-卡数据的系统几乎都包含了几个表的service mapper *mapper.xml文件，获取某个信息数据方式一致，有重复编码；</p> <p>（4）用户每个系统自己做了缓存，而更新数据不在每个系统中，无法做到缓存的更新，导致严重的数据一致性问题，例如：前面开放平台的用户中心，当APP用户修改了昵称时，而用户中心显示的数据还是之前的昵称，原因在于shared的缓存未及时更新；</p></blockquote> <h3 id="涉及表"><a href="#涉及表" class="header-anchor">#</a> 涉及表</h3> <ul><li>用户表：core_user</li> <li>车辆表：global_user_car</li> <li>设备表：core_terminal_device、core_terminal_device_ext</li> <li>sim卡表：si_sim_info</li></ul> <h3 id="接口开放方式"><a href="#接口开放方式" class="header-anchor">#</a> 接口开放方式</h3> <ul><li>RPC方式访问（前提：需要集成Dubbo 性能要求较高的系统）</li> <li>SpringCloud的FeignClient方式访问（需要集成SpringCloud）</li></ul> <h2 id="方案-2"><a href="#方案-2" class="header-anchor">#</a> 方案</h2> <p>分三个阶段完成</p> <p>第一阶段：从库使用阶段（目的：先减轻主库压力，从物理上实现读写分离）</p> <p>第二阶段：缓存启用阶段（目的：提升性能）</p> <p>第三阶段：完善接口阶段，确定各接口是否启用本地缓存（目的：扩展，再次提升性能）</p> <h3 id="第一阶段：从库使用"><a href="#第一阶段：从库使用" class="header-anchor">#</a> 第一阶段：从库使用</h3> <h4 id="目标"><a href="#目标" class="header-anchor">#</a> 目标</h4> <p>基于MySQL构建物理上的读写分离，减轻主库压力</p> <ul><li>业务层通过负载均衡访问MySQL从库，极大程度的降低MySQL主库压力;</li> <li>MySQL集群化（一主多从）部署；</li> <li>统一的对外数据访问接口；</li> <li>提供用户信息、车辆信息、设备信息、卡信息读取、用户及车辆上下文信息读取接口；</li> <li>集成Dubbo及SpringCloud提供API访问；</li></ul> <h4 id="技术思路"><a href="#技术思路" class="header-anchor">#</a> 技术思路</h4> <p><a data-fancybox="" title="1569468195657" href="/assets/1569468195657.png"><img src="/assets/1569468195657.png" alt="1569468195657"></a></p> <ul><li>搭建MySQL数据库从库集群，基础数据池系统通过连接负载均衡并路由到MySQL数据库从库集群中的一个salve节点，直接从salve节点读取数据。</li> <li>提供用户信息、车辆信息、设备信息、卡信息读取、用户及车辆上下文信息读取接口，通过RPC和HTTP方式暴露给其他应用系统；</li> <li>保持之前各系统对MySQL主库的写操作，物理上实现用户信息、车辆信息、设备信息、卡信息的读写分离；</li></ul> <h3 id="第二阶段：缓存启用"><a href="#第二阶段：缓存启用" class="header-anchor">#</a> 第二阶段：缓存启用</h3> <h4 id="目标-2"><a href="#目标-2" class="header-anchor">#</a> 目标</h4> <p>基于MySQL及Redis设计构建统一的缓存服务</p> <ul><li>业务层访问MySQL及Redis方式统一；</li> <li>MySQL集群化（MySQL跨机分库分表集群）/Redis集群化部署；</li> <li>将业务双写MySQL及Redis的方式改为MySQL到Redis底层binlog数据同步方式完成同步；</li> <li>异构数据存储支持最终一致性数据读写服务；</li> <li>支持存储层面扩容缩容、故障转移业务无感知；</li> <li>集群设计满足QPS/TPS需求（大类业务适度拆分到不同集群中）；</li> <li>统一的对外数据访问接口；</li></ul> <h4 id="技术思路-2"><a href="#技术思路-2" class="header-anchor">#</a> 技术思路</h4> <p><a data-fancybox="" title="1569481260401" href="/assets/1569481260401.png"><img src="/assets/1569481260401.png" alt="1569481260401"></a></p> <p>使用阿里开源的Canal进行MySQL Binlog数据的抽取，开发一个数据转换工具将从Binlog中解析出的数据转换成自带schema的json数据并写入Kafka中。开发kafka数据订阅同步服务，将消费kafka中信息并同步给Redis。</p> <h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h4> <p>异步缓存更新：基于订阅Binlog的同步机制实现异步更新缓存</p> <ul><li>读Redis：热数据基本都在Redis；</li> <li>写MySQL:增删改都是操作MySQL；</li> <li>更新Redis数据：MySQ的数据操作binlog，来更新到Redis；</li></ul> <h3 id="第三阶段：完善api，local-cache确定"><a href="#第三阶段：完善api，local-cache确定" class="header-anchor">#</a> 第三阶段：完善API，Local Cache确定</h3> <p>API采用持续更新和完善的方式，旨在解决对人-车-设备-卡数据访问量较高的API，为了进一步提升性能，某些不变量接口可启用本地缓存的方式处理。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/link/dataCenter/API_User.html">用户API</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.822e4d04.js" defer></script><script src="/assets/js/2.4b49f509.js" defer></script><script src="/assets/js/11.f07c6990.js" defer></script>
  </body>
</html>
